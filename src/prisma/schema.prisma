generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum GlobalRole {
  SUPER_ADMIN
  ADMIN
  TEAM_MEMBER
}

enum ProjectRole {
  OWNER
  EDITOR
  VIEWER
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  users     User[]
  meetings  Meeting[]
  projects  Project[]
  invites   Invite[]
  conversations Conversation[]
  integrationConnections IntegrationConnection[]
  auditLogs AuditLog[]
}

enum Role {
  ADMIN
  PM
  MEMBER
}

model User {
  id                  String               @id @default(cuid())
  organizationId      String
  email               String               @unique
  passwordHash        String
  name                String
  avatarUrl           String?
  role                Role                 @default(ADMIN)
  globalRole          GlobalRole           @default(ADMIN)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  attendees           Attendee[]
  messages            Message[]
  conversationsCreated Conversation[] @relation("ConversationCreatedBy")
  auditLogs           AuditLog[]
  projectMemberships  ProjectMember[]
  createdProjects     Project[]            @relation("ProjectCreatedBy")

  @@index([organizationId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Invite {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
}

model Meeting {
  id              String   @id @default(cuid())
  organizationId  String
  title           String
  agenda          String?
  scheduledTime   DateTime
  status          String   @default("scheduled")
  duration        Int?
  meetingLink     String?
  botStatus       String? 
  transcriptStatus String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  attendees       Attendee[]
  transcript      TranscriptSegment[]
  actionItems     ActionItem[]

  @@index([organizationId])
}

model Attendee {
  id         String   @id @default(cuid())
  meetingId  String
  name       String
  email      String
  joined     Boolean  @default(false)
  isBot      Boolean  @default(false)
  userId     String?
  meeting    Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([meetingId])
}

model TranscriptSegment {
  id         String   @id @default(cuid())
  meetingId  String
  speaker    String
  timestamp  Int
  text       String
  meeting    Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
}

model ActionItem {
  id         String   @id @default(cuid())
  meetingId  String
  text       String
  assignee   String?
  dueDate    DateTime?
  meeting    Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
}

model Project {
  id            String   @id @default(cuid())
  organizationId String
  name          String
  client        String?
  clientName    String?
  progress      Int      @default(0)
  health        String? 
  status        String? 
  dueDate       DateTime?
  asanaLink     String?
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks         ProjectTask[]
  members       ProjectMember[]
  createdBy     User?        @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  invites       ProjectInvite[]

  @@index([organizationId])
}

model ProjectMember {
  id          String      @id @default(cuid())
  userId      String
  projectId   String
  projectRole ProjectRole
  joinedAt    DateTime    @default(now())
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([projectId])
  @@index([userId])
}

model ProjectInvite {
  id          String      @id @default(cuid())
  projectId   String
  email       String
  projectRole ProjectRole
  tokenHash   String      @unique
  expiresAt   DateTime
  used        Boolean     @default(false)
  createdAt   DateTime    @default(now())
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@unique([projectId, email])
}
model ProjectTask {
  id         String   @id @default(cuid())
  projectId  String
  title      String
  status     String   @default("todo")
  assignee   String?
  dueDate    DateTime?
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Conversation {
  id              String   @id @default(cuid())
  organizationId  String
  createdById     String
  createdAt       DateTime @default(now())
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User      @relation("ConversationCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  messages        Message[]

  @@index([organizationId])
}

model Message {
  id              String   @id @default(cuid())
  conversationId  String
  userId          String?
  role            String
  content         String
  meetingId       String?
  meetingTitle    String?
  timestamp       Int?
  createdAt       DateTime @default(now())
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User?       @relation(fields: [userId], references: [id])

  @@index([conversationId])
}

model Integration {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  connections IntegrationConnection[]
}

model IntegrationConnection {
  id            String   @id @default(cuid())
  organizationId String
  integrationId String
  status        String   @default("disconnected")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@unique([organizationId, integrationId])
}

model WebhookEvent {
  id         String   @id @default(cuid())
  type       String
  signature  String
  payload    Json
  receivedAt DateTime @default(now())
}

model AuditLog {
  id            String   @id @default(cuid())
  organizationId String
  userId        String?
  action        String
  meta          Json?
  createdAt     DateTime @default(now())
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user          User? @relation(fields: [userId], references: [id])

  @@index([organizationId])
}
